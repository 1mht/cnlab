## 中文翻译与解释

### Part B: 套接字编程（Socket Programming）

如课堂所述，套接字编程是实现网络通信程序的标准方式。虽然最初是在 Unix 系统用 C 语言开发的，但套接字抽象本身是通用的，不依赖于某个操作系统或编程语言，因此程序员可以在多种环境下编写正确的网络程序。

本作业的这一部分将让你体验基本的套接字编程。你需要编写两对基于 TCP 的客户端和服务器程序，实现文本消息在互联网中的发送与接收。**其中一对必须使用 C 语言编写**，另一对可以用 **Python 或 Go** 任意一种语言来写，只需选一种即可。Python 版本更简洁，但如果选择 Go，对后续作业会有帮助。

客户端和服务器程序必须满足以下详细要求。务必在编程前后仔细阅读这些规范，确保你的代码实现完全符合：

---

#### 服务器规范

- 每个服务器程序应监听一个套接字，等待客户端连接，接收客户端发来的消息，将消息打印到标准输出，然后继续无限等待下一个客户端。
- 服务器程序需接受一个命令行参数，即监听的端口号。
- 服务器要在无限循环中接受和处理客户端通信，允许多个客户端连接到同一服务器。服务器只会因外部信号（如按下 `ctrl-c` 触发的 SIGINT）而退出。
- 服务器需保持一个短的（5-10）客户端队列，并顺序处理多个客户端连接尝试。实际应用中通常会为每个客户端连接并发处理（如 fork 新进程），但**本作业不要求并发处理**。
- 对于套接字编程相关库函数可能返回的错误，服务器应优雅地处理。与客户端连接有关的错误不应导致服务器退出，其他错误可导致服务器退出。

---

#### 客户端规范

- 每个客户端程序应连接服务器，从标准输入读取消息，将消息发送，然后退出。
- 客户端需完整读取并发送标准输入内容，直到遇到 EOF（文件结束）。
- 客户端需接受两个命令行参数：服务器 IP 地址和端口号。
- 客户端必须能处理任意大消息，采用分块读写，而不是一次性全部读入内存。
- 客户端需处理部分发送（即一次 send 只发送了部分数据），要继续发送剩余数据直到全部发送完毕。
- 客户端需优雅地处理套接字编程相关库函数可能返回的错误。

---

#### 开始步骤

- 所有编译和测试请在 Vagrant 虚拟机上进行。可以在 VM 上用 Emacs/Vim 编辑代码，或在本地开发后拷贝进去。
- 进入虚拟机后运行 `cd /vagrant` 进入课程目录。
- 已提供代码框架在 `assignment1/client_server/` 目录。请先阅读和理解这些代码。
- **只在标有 `TODO` 的位置编写你的代码**，每个客户端和服务器文件有一个 `TODO` 部分。可以添加函数，但不要改文件名，自动测试会用这些文件名。

---

#### 各语言说明

##### C 语言

- 推荐阅读 “Beej's Guide to Network Programming”：[系统调用部分](https://beej.us/guide/bgnet/html/#system-calls-or-bust) 和 [客户端/服务器示例](https://beej.us/guide/bgnet/html/#client-server-background)。
- 需在 `client-c.c` 和 `server-c.c` 的 `TODO` 区域实现代码。参考实现各约 70 行代码（含注释和空行）。
- 错误处理：对设置了全局变量 `errno` 的函数用 `perror`，其他用标准错误打印即可。
- 使用提供的 Makefile，在 `assignment1/client_server` 目录下运行 `make` 编译。
- 运行方式：服务器 `./server-c [port] > [output file]`，客户端 `./client-c [server IP] [server port] < [message file]`。

##### Python

- 推荐阅读官方文档：[socket 概述](https://docs.python.org/2/library/socket.html)、[socket 对象](https://docs.python.org/2/library/socket.html#socket-objects)、[示例](https://docs.python.org/2/library/socket.html#example)。
- 需在 `client-python.py` 和 `server-python.py` 的 `TODO` 区域实现代码。参考实现各约 15 行代码。
- Python socket 函数会自动抛异常，无需额外错误处理。
- 运行方式：服务器 `python server-python.py [port] > [output file]`，客户端 `python client-python.py [server IP] [server port] < [message file]`。

##### Go

- 推荐阅读官方文档：[net 包](https://golang.org/pkg/net/)、[Conn 类型](https://golang.org/pkg/net/#Conn)。
- 需在 `client-go.go` 和 `server-go.go` 的 `TODO` 区域实现代码。参考实现各约 40 行代码。
- Go 的 Listen 默认有连接队列，无需额外编程。
- 使用提供的 Makefile，在 `assignment1/client_server` 目录下运行 `make go` 编译。
- 运行方式：服务器 `./server-go [port] > [output file]`，客户端 `./client-go [server IP] [server port] < [message file]`。

---

#### 测试

- 推荐用客户端向服务器发送消息进行测试。服务器可后台运行（命令后加 `&`）或用另一个 SSH 窗口。
- 使用 `127.0.0.1` 作为服务器 IP，端口选 10000~60000 的高位端口。
- 已提供 Bash 测试脚本 `test_client_server.sh`，可测试所有 4 种客户端/服务器组合（C 对 C，C 对 Python/Go 等），覆盖如下几种消息：
  1. 短消息，如 "Go Tigers!\n"
  2. 长的随机字母数字消息
  3. 长的随机二进制消息
  4. 多个短消息由不同客户端依次发送到同一服务器
  5. 多个长随机字母数字消息由不同客户端并发发送到同一服务器
- 运行脚本：`./test_client_server.sh [python|go] [server port]`，如遇权限错误可用 `chmod 744 test_client_server.sh`。
- 每组测试会输出 "SUCCESS" 表示消息发送和接收正确，否则输出消息差异。

---

#### 调试建议

- 框架代码已定义缓冲区大小和队列长度常量，务必使用，勿硬编码。
- 各语言有多种标准输入/输出读取写入方法，只要不一次性读入全部内容、不修改消息即可。
- 使用缓冲写入标准输出时，记得调用 flush，以防长消息末尾未输出。
- 测试时确保客户端用 `127.0.0.1` 作为服务器 IP，端口号一致。
- 如果出现 “address already in use” 错误，确认没有服务器进程未关闭，或重启 ssh 会话。
- 其他连接错误可尝试更换端口（10000~60000）。

---

#### Q&A

- **vagrant up 报错怎么办？**
  大部分 `==> default:` 开头的警告可以忽略，但如果导致启动失败需处理。用 `vagrant status` 可查看虚拟机状态。常见错误处理见原文。
- **recv() 要加 MSG_WAITALL 吗？**
  不需要，服务器无法提前知道要收多少数据，应循环调用 recv() 直到没有数据可收。
- **需要处理 SIGINT 等信号吗？**
  本作业不需要，默认行为即可，但实际项目中推荐处理。
- **用流式套接字还是数据报套接字？**
  用流式（TCP）套接字，确保消息完整送达。
- **客户端要等服务器回复吗？**
  不需要，发送完消息后即可退出。
- **服务器要并发处理客户端吗？**
  不需要，本作业只要求顺序处理。

---

#### 提交与评分

- 需将所有修改后的客户端和服务器文件上传到 CS TigerFile 指定页面。
- 评分时会用测试脚本和额外大消息、多客户端等场景测试，请自行多做测试确保规范。
- **代码不通过编译将按严格标准扣分**，为保证部分分，务必确保可以编译通过。
- 除 C 客户端/服务器外，第二对必须是 Python 或 Go，同一语言的客户端和服务器。如果提交了 Python 和 Go 两种实现，只会评分 Python，**不评分两者择优**。也不能只交 Python 客户端+Go 服务器，或反之，必须同一语言。

---

### 解释

本作业要求你用 C 语言实现一对 TCP 客户端和服务器，还需用 Python 或 Go 实现另一对。每种实现都需严格按照规范处理消息收发、错误、参数、缓冲等，测试要覆盖多种消息和多客户端场景。务必按框架代码指定的位置完成，实现后充分测试，最终按作业提交说明上传文件。评分重点是功能正确性和代码可编译性。